<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Endurance - Viltrum Fitness</title>
  
  <style id="fouc-prevention">
    select, input:not([type="checkbox"]):not([type="radio"]), button { 
      -webkit-appearance: none !important; 
      appearance: none !important;
    }
    html, body { background: #000000 !important; }
  </style>
  
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet" />
  <link rel="manifest" href="../manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" href="../icons/icon-192x192.png" />
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100vh; height: var(--dvh-px, 100vh);
      width: 100%; font-family: 'Staatliches', sans-serif;
      background: #000; color: #FFF; overflow: hidden;
    }
    .endurance-container {
      height: 100vh; height: var(--dvh-px, 100vh);
      display: flex; flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    header {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 0 4vw; background: rgba(0,0,0,0.98);
      border-bottom: 1px solid rgba(255,255,255,0.08); height: 10vh;
    }
    .back-btn {
      padding: 1vh 3vw; background: transparent; border: 2px solid #FFF;
      border-radius: 10px; color: #FFF; font-family: 'Staatliches', sans-serif;
      font-size: 1.8vh; cursor: pointer; transition: all 0.3s ease;
    }
    .back-btn:hover { background: rgba(255,255,255,0.1); }
    header h1 { font-size: 2.5vh; letter-spacing: 2px; }
    .header-spacer { width: 80px; }

    .selector-view { flex: 1; display: flex; flex-direction: column; padding: 2vh 4vw; overflow: hidden; }
    .selector-view.hidden { display: none; }
    .selector-title { text-align: center; margin-bottom: 2vh; }
    .selector-title h2 { font-size: 2.8vh; letter-spacing: 1.5px; margin-bottom: 0.5vh; }
    .selector-title p { color: #B0B0B0; font-size: 1.6vh; }

    .workout-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5vh; padding: 1vh 0; -webkit-overflow-scrolling: touch; }
    .workout-card {
      background: linear-gradient(135deg, rgba(77,77,77,0.6), rgba(50,50,50,0.4));
      border: 2px solid #5D5D5D; border-radius: 15px; padding: 2vh 3vw;
      cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 3vw;
    }
    .workout-card:hover { border-color: #FFF; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
    .workout-icon {
      width: 6vh; height: 6vh; background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2); border-radius: 12px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .workout-icon svg { width: 3.5vh; height: 3.5vh; color: #FFF; }
    .workout-info { flex: 1; }
    .workout-info h3 { font-size: 2.2vh; letter-spacing: 1px; margin-bottom: 0.3vh; }
    .workout-info p { color: #B0B0B0; font-size: 1.4vh; }
    .workout-arrow { color: #B0B0B0; font-size: 2vh; }

    .workout-view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .workout-view.active { display: flex; }
    .workout-header {
      flex-shrink: 0; padding: 1.5vh 4vw; background: rgba(30,30,30,0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: center; justify-content: space-between;
    }
    .workout-header h2 { font-size: 2.2vh; letter-spacing: 1.5px; }
    .workout-progress-badge {
      padding: 0.8vh 2vw; background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
      font-size: 1.4vh; letter-spacing: 1px;
    }

    /* GPS Tracker */
    .gps-tracker {
      background: linear-gradient(135deg, rgba(30,30,30,0.95), rgba(20,20,20,0.98));
      border-bottom: 2px solid rgba(76,175,80,0.4); padding: 1.5vh 4vw;
      display: none; flex-shrink: 0;
    }
    .gps-tracker.active { display: block; }
    .gps-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2vh; }
    .gps-status { display: flex; align-items: center; gap: 1.5vw; font-size: 1.3vh; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .gps-dot { width: 10px; height: 10px; border-radius: 50%; background: #666; transition: all 0.3s ease; }
    .gps-dot.searching { background: #FFC107; animation: pulse 1.5s infinite; }
    .gps-dot.active { background: #4CAF50; box-shadow: 0 0 10px rgba(76,175,80,0.5); }
    .gps-dot.error { background: #F44336; }
    @keyframes pulse { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.5; transform:scale(1.2); } }
    .gps-toggle {
      padding: 0.8vh 2.5vw; background: rgba(76,175,80,0.2);
      border: 1px solid rgba(76,175,80,0.5); border-radius: 8px; color: #4CAF50;
      font-family: 'Staatliches', sans-serif; font-size: 1.3vh; cursor: pointer; transition: all 0.3s ease;
    }
    .gps-toggle:hover { background: rgba(76,175,80,0.3); }
    .gps-toggle.tracking { background: rgba(244,67,54,0.2); border-color: rgba(244,67,54,0.5); color: #F44336; }
    .gps-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2vw; }
    .gps-stat { text-align: center; padding: 0.8vh 0; }
    .gps-stat-value { font-size: 4vh; font-weight: bold; color: #FFF; line-height: 1; margin-bottom: 0.3vh; }
    .gps-stat-value.highlight { color: #4CAF50; }
    .gps-stat-label { font-size: 1.1vh; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .gps-accuracy { text-align: center; font-size: 1vh; color: #555; margin-top: 0.8vh; padding-top: 0.8vh; border-top: 1px solid rgba(255,255,255,0.08); }

    .line-list-container { flex: 1; overflow-y: auto; padding: 2vh 4vw; -webkit-overflow-scrolling: touch; }
    .line-item {
      background: rgba(40,40,40,0.6); border: 2px solid rgba(100,100,100,0.4);
      border-radius: 12px; padding: 2vh 3vw; margin-bottom: 1.5vh;
      transition: all 0.3s ease; position: relative;
    }
    .line-item.current { background: rgba(76,175,80,0.15); border-color: #4CAF50; box-shadow: 0 0 20px rgba(76,175,80,0.3); }
    .line-item.completed { background: rgba(50,50,50,0.4); border-color: rgba(76,175,80,0.5); opacity: 0.7; }
    .line-item.completed::after { content: '‚úì'; position: absolute; right: 3vw; top: 50%; transform: translateY(-50%); color: #4CAF50; font-size: 2.5vh; }
    .line-section { font-size: 1.2vh; color: #888; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.5vh; }
    .line-text { font-size: 2vh; line-height: 1.4; color: #FFF; }
    .line-item.current .line-text { font-size: 2.2vh; font-weight: bold; }

    .workout-controls {
      flex-shrink: 0; padding: 2vh 4vw 3vh; background: rgba(20,20,20,0.98);
      border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 3vw;
    }
    .control-btn {
      flex: 1; padding: 2vh; border-radius: 12px; font-family: 'Staatliches', sans-serif;
      font-size: 2vh; letter-spacing: 1.5px; cursor: pointer; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center; gap: 1vw;
    }
    .control-btn.primary { background: #FFF; color: #000; border: none; }
    .control-btn.primary:hover { background: #E0E0E0; transform: scale(1.02); }
    .control-btn.secondary { background: transparent; color: #FFF; border: 2px solid #FFF; }
    .control-btn.secondary:hover { background: rgba(255,255,255,0.1); }
    .control-btn.complete { background: #4CAF50; color: #FFF; border: none; }

    .no-workouts { flex: 1; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 4vh; text-align: center; }
    .no-workouts svg { width: 10vh; height: 10vh; color: #555; margin-bottom: 2vh; }
    .no-workouts h3 { font-size: 2.5vh; margin-bottom: 1vh; color: #888; }
    .no-workouts p { color: #666; font-size: 1.6vh; max-width: 80%; }

    .loading { flex: 1; display: flex; align-items: center; justify-content: center; }
    .loading-spinner { width: 5vh; height: 5vh; border: 3px solid rgba(255,255,255,0.2); border-top-color: #FFF; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .completion-screen { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 4vh; text-align: center; }
    .completion-screen.active { display: flex; }
    .completion-icon { width: 15vh; height: 15vh; background: rgba(76,175,80,0.2); border: 3px solid #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 3vh; }
    .completion-icon svg { width: 8vh; height: 8vh; color: #4CAF50; }
    .completion-screen h2 { font-size: 3.5vh; letter-spacing: 2px; margin-bottom: 1vh; }
    .completion-screen p { color: #B0B0B0; font-size: 1.8vh; margin-bottom: 3vh; }
    .completion-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 3vw; margin-bottom: 3vh; padding: 2vh 4vw; background: rgba(255,255,255,0.05); border-radius: 12px; width: 80%; max-width: 300px; }
    .completion-stat { text-align: center; }
    .completion-stat-value { font-size: 3vh; font-weight: bold; color: #4CAF50; }
    .completion-stat-label { font-size: 1.4vh; color: #888; text-transform: uppercase; }
    .completion-btn { padding: 2vh 6vw; background: #FFF; color: #000; border: none; border-radius: 12px; font-family: 'Staatliches', sans-serif; font-size: 2vh; letter-spacing: 1.5px; cursor: pointer; transition: all 0.3s ease; }
    .completion-btn:hover { background: #E0E0E0; transform: scale(1.02); }

    @media (max-width: 768px) {
      header { padding: 0 3vw; }
      .back-btn { padding: 1vh 2.5vw; font-size: 1.6vh; }
      .workout-controls { padding: 1.5vh 3vw 2.5vh; gap: 2vw; }
      .control-btn { padding: 1.8vh; font-size: 1.8vh; }
    }
  </style>
</head>
<body>
  <div class="endurance-container">
    <header>
      <button class="back-btn" onclick="goBack()">‚Üê INDIETRO</button>
      <h1>ENDURANCE</h1>
      <div class="header-spacer"></div>
    </header>

    <div id="loading-view" class="loading"><div class="loading-spinner"></div></div>

    <div id="selector-view" class="selector-view hidden">
      <div class="selector-title">
        <h2>üèÉ RUNNING WORKOUTS</h2>
        <p>Seleziona il tuo allenamento</p>
      </div>
      <div id="workout-list" class="workout-list"></div>
    </div>

    <div id="no-workouts" class="no-workouts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
      </svg>
      <h3>NESSUN WORKOUT DISPONIBILE</h3>
      <p>I workout di running saranno disponibili presto.</p>
    </div>

    <div id="workout-view" class="workout-view">
      <div class="workout-header">
        <h2 id="current-workout-name">-</h2>
        <span id="progress-badge" class="workout-progress-badge">0 / 0</span>
      </div>

      <div id="gps-tracker" class="gps-tracker">
        <div class="gps-header">
          <div class="gps-status">
            <div id="gps-dot" class="gps-dot"></div>
            <span id="gps-status-text">GPS OFF</span>
          </div>
          <button id="gps-toggle" class="gps-toggle" onclick="toggleGPS()">üõ∞Ô∏è ATTIVA GPS</button>
        </div>
        <div class="gps-stats">
          <div class="gps-stat">
            <div id="gps-distance" class="gps-stat-value highlight">0.00</div>
            <div class="gps-stat-label">KM</div>
          </div>
          <div class="gps-stat">
            <div id="gps-pace" class="gps-stat-value">--:--</div>
            <div class="gps-stat-label">MIN/KM</div>
          </div>
          <div class="gps-stat">
            <div id="gps-time" class="gps-stat-value">00:00</div>
            <div class="gps-stat-label">TEMPO</div>
          </div>
        </div>
        <div id="gps-accuracy" class="gps-accuracy">Precisione: --</div>
      </div>

      <div id="line-list" class="line-list-container"></div>

      <div class="workout-controls">
        <button class="control-btn secondary" onclick="previousLine()">‚Üê PREV</button>
        <button id="next-btn" class="control-btn primary" onclick="nextLine()">NEXT ‚Üí</button>
      </div>
    </div>

    <div id="completion-screen" class="completion-screen">
      <div class="completion-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h2>OTTIMO LAVORO! üéâ</h2>
      <p>Hai completato il workout di running</p>
      <div id="completion-stats" class="completion-stats" style="display: none;">
        <div class="completion-stat">
          <div id="final-distance" class="completion-stat-value">0.00 km</div>
          <div class="completion-stat-label">Distanza</div>
        </div>
        <div class="completion-stat">
          <div id="final-time" class="completion-stat-value">00:00</div>
          <div class="completion-stat-label">Tempo</div>
        </div>
      </div>
      <button class="completion-btn" onclick="goBackToDashboard()">TORNA ALLA DASHBOARD</button>
    </div>
  </div>

  <script src="../viewport.js"></script>
  <script type="module">
    import { GOOGLE_SCRIPT_URL } from '../js/config.js';

    let runWorkouts = {}, userRunWorkouts = [], currentWorkout = null, currentLineIndex = 0;
    let gpsWatchId = null, gpsPositions = [], totalDistance = 0, gpsStartTime = null, gpsTimerInterval = null, isGPSTracking = false, wakeLock = null;

    async function init() {
      console.log('üèÉ Initializing Endurance...');
      try {
        const loggedUser = localStorage.getItem('loggedUser');
        if (!loggedUser) { window.location.href = '../index.html'; return; }

        let data = null;
        const cached = sessionStorage.getItem('viltrum_session_data');
        if (cached) { data = JSON.parse(cached); }
        else {
          const response = await fetch(GOOGLE_SCRIPT_URL);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          data = await response.json();
          sessionStorage.setItem('viltrum_session_data', JSON.stringify(data));
        }

        runWorkouts = data.runWorkouts || {};
        userRunWorkouts = Object.keys(runWorkouts);
        document.getElementById('loading-view').style.display = 'none';

        if (userRunWorkouts.length === 0) {
          document.getElementById('no-workouts').style.display = 'flex';
        } else {
          document.getElementById('selector-view').classList.remove('hidden');
          renderWorkoutList();
        }
      } catch (error) {
        console.error('‚ùå Failed:', error);
        document.getElementById('loading-view').style.display = 'none';
        document.getElementById('no-workouts').style.display = 'flex';
      }
    }

    // GPS Functions
    window.toggleGPS = function() { isGPSTracking ? stopGPSTracking() : startGPSTracking(); };

    async function startGPSTracking() {
      if (!navigator.geolocation) { alert('GPS non disponibile'); return; }
      console.log('üõ∞Ô∏è Starting GPS...');
      updateGPSStatus('searching', 'RICERCA GPS...');
      document.getElementById('gps-toggle').textContent = '‚èπÔ∏è STOP GPS';
      document.getElementById('gps-toggle').classList.add('tracking');
      gpsPositions = []; totalDistance = 0; gpsStartTime = Date.now();
      gpsTimerInterval = setInterval(updateElapsedTime, 1000);
      gpsWatchId = navigator.geolocation.watchPosition(handleGPSSuccess, handleGPSError, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
      isGPSTracking = true;
      if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {} }
    }

    function stopGPSTracking() {
      if (gpsWatchId !== null) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
      if (gpsTimerInterval) { clearInterval(gpsTimerInterval); gpsTimerInterval = null; }
      updateGPSStatus('off', 'GPS OFF');
      document.getElementById('gps-toggle').textContent = 'üõ∞Ô∏è ATTIVA GPS';
      document.getElementById('gps-toggle').classList.remove('tracking');
      isGPSTracking = false;
      if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    function handleGPSSuccess(position) {
      const { latitude, longitude, accuracy, speed } = position.coords;
      console.log(`üìç ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${accuracy.toFixed(0)}m)`);
      updateGPSStatus('active', 'GPS ATTIVO');
      document.getElementById('gps-accuracy').textContent = `Precisione: ¬±${accuracy.toFixed(0)}m`;
      if (accuracy > 50) return;
      if (gpsPositions.length > 0) {
        const last = gpsPositions[gpsPositions.length - 1];
        const dist = calcDist(last.latitude, last.longitude, latitude, longitude);
        if (dist < 100 && dist > 1) { totalDistance += dist; updateDistanceDisplay(); }
      }
      gpsPositions.push({ latitude, longitude, accuracy, speed });
      if (speed > 0.5) updatePaceFromSpeed(speed); else updatePaceFromDistance();
    }

    function handleGPSError(error) {
      console.error('GPS Error:', error.message);
      if (error.code === error.PERMISSION_DENIED) { alert('Abilita i permessi GPS'); stopGPSTracking(); }
      updateGPSStatus('error', 'ERRORE GPS');
    }

    function updateGPSStatus(state, text) {
      const dot = document.getElementById('gps-dot');
      dot.className = 'gps-dot' + (state === 'searching' ? ' searching' : state === 'active' ? ' active' : state === 'error' ? ' error' : '');
      document.getElementById('gps-status-text').textContent = text;
    }

    function calcDist(lat1, lon1, lat2, lon2) {
      const R = 6371000, œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180, ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateDistanceDisplay() { document.getElementById('gps-distance').textContent = (totalDistance / 1000).toFixed(2); }
    function updateElapsedTime() {
      if (!gpsStartTime) return;
      const elapsed = Date.now() - gpsStartTime, min = Math.floor(elapsed / 60000), sec = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('gps-time').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }
    function updatePaceFromSpeed(speed) {
      if (speed <= 0) { document.getElementById('gps-pace').textContent = '--:--'; return; }
      const pace = 1000 / speed, min = Math.floor(pace / 60), sec = Math.floor(pace % 60);
      if (min < 20) document.getElementById('gps-pace').textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    }
    function updatePaceFromDistance() {
      if (!gpsStartTime || totalDistance < 50) return;
      const elapsedMin = (Date.now() - gpsStartTime) / 60000, distKm = totalDistance / 1000;
      if (distKm > 0) { const pace = elapsedMin / distKm, min = Math.floor(pace), sec = Math.floor((pace % 1) * 60); if (min < 20) document.getElementById('gps-pace').textContent = `${min}:${sec.toString().padStart(2,'0')}`; }
    }

    function renderWorkoutList() {
      const container = document.getElementById('workout-list');
      container.innerHTML = '';
      userRunWorkouts.forEach(name => {
        const workout = runWorkouts[name], lineCount = workout?.lines?.length || 0;
        const card = document.createElement('div');
        card.className = 'workout-card';
        card.onclick = () => startWorkout(name);
        card.innerHTML = `<div class="workout-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v8"/><path d="M8 21l4-5 4 5"/><path d="M6 12l6-2 6 2"/></svg></div><div class="workout-info"><h3>${name}</h3><p>${lineCount} passaggi</p></div><span class="workout-arrow">‚Üí</span>`;
        container.appendChild(card);
      });
    }

    function startWorkout(workoutName) {
      currentWorkout = runWorkouts[workoutName]; currentLineIndex = 0;
      if (!currentWorkout?.lines?.length) { alert('Workout non valido'); return; }
      document.getElementById('current-workout-name').textContent = workoutName;
      document.getElementById('selector-view').classList.add('hidden');
      document.getElementById('workout-view').classList.add('active');
      document.getElementById('gps-tracker').classList.add('active');
      renderLines(); updateProgress(); scrollToCurrentLine();
    }

    function renderLines() {
      const container = document.getElementById('line-list');
      container.innerHTML = '';
      currentWorkout.lines.forEach((line, i) => {
        const div = document.createElement('div');
        div.className = 'line-item' + (i === currentLineIndex ? ' current' : i < currentLineIndex ? ' completed' : '');
        div.id = `line-${i}`;
        div.innerHTML = (line.section ? `<div class="line-section">${line.section}</div>` : '') + `<div class="line-text">${line.text}</div>`;
        div.onclick = () => jumpToLine(i);
        container.appendChild(div);
      });
    }

    window.nextLine = function() { if (currentLineIndex < currentWorkout.lines.length - 1) { currentLineIndex++; updateLineStates(); updateProgress(); scrollToCurrentLine(); } else completeWorkout(); };
    window.previousLine = function() { if (currentLineIndex > 0) { currentLineIndex--; updateLineStates(); updateProgress(); scrollToCurrentLine(); } };
    function jumpToLine(i) { currentLineIndex = i; updateLineStates(); updateProgress(); scrollToCurrentLine(); }
    function updateLineStates() {
      currentWorkout.lines.forEach((_, i) => {
        const el = document.getElementById(`line-${i}`);
        if (!el) return;
        el.classList.remove('current', 'completed');
        if (i === currentLineIndex) el.classList.add('current');
        else if (i < currentLineIndex) el.classList.add('completed');
      });
      const btn = document.getElementById('next-btn');
      if (currentLineIndex >= currentWorkout.lines.length - 1) { btn.textContent = 'COMPLETA ‚úì'; btn.classList.remove('primary'); btn.classList.add('complete'); }
      else { btn.textContent = 'NEXT ‚Üí'; btn.classList.remove('complete'); btn.classList.add('primary'); }
    }
    function updateProgress() { document.getElementById('progress-badge').textContent = `${currentLineIndex + 1} / ${currentWorkout.lines.length}`; }
    function scrollToCurrentLine() { document.getElementById(`line-${currentLineIndex}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }

    function completeWorkout() {
      if (isGPSTracking) stopGPSTracking();
      if (totalDistance > 0 || gpsStartTime) {
        document.getElementById('completion-stats').style.display = 'grid';
        document.getElementById('final-distance').textContent = (totalDistance / 1000).toFixed(2) + ' km';
        if (gpsStartTime) { const elapsed = Date.now() - gpsStartTime, min = Math.floor(elapsed / 60000), sec = Math.floor((elapsed % 60000) / 1000); document.getElementById('final-time').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
      }
      document.getElementById('workout-view').classList.remove('active');
      document.getElementById('completion-screen').classList.add('active');
    }

    window.goBack = function() {
      if (document.getElementById('workout-view').classList.contains('active')) {
        if (isGPSTracking) stopGPSTracking();
        document.getElementById('workout-view').classList.remove('active');
        document.getElementById('completion-screen').classList.remove('active');
        document.getElementById('selector-view').classList.remove('hidden');
        document.getElementById('gps-tracker').classList.remove('active');
        currentWorkout = null; currentLineIndex = 0; totalDistance = 0; gpsStartTime = null;
        document.getElementById('gps-distance').textContent = '0.00';
        document.getElementById('gps-pace').textContent = '--:--';
        document.getElementById('gps-time').textContent = '00:00';
      } else window.location.href = 'dashboard.html';
    };
    window.goBackToDashboard = function() { window.location.href = 'dashboard.html'; };

    document.addEventListener('keydown', (e) => {
      if (!currentWorkout) return;
      if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') { e.preventDefault(); nextLine(); }
      else if (e.key === 'ArrowLeft') { e.preventDefault(); previousLine(); }
      else if (e.key === 'Escape') goBack();
    });

    document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'visible' && isGPSTracking && 'wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {} } });
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
